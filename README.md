# Калькулятор допродажів KEYCRM

Google Apps Script для автоматичного розрахунку маржі та бонусів менеджерів з допродажів KEYCRM.

## Функціонал

- ✅ Отримання всіх допродажів з KEYCRM через API
- ✅ Розрахунок маржі (ціна продажу - собівартість)
- ✅ Автоматичний розрахунок бонусу менеджера (50% від маржі, якщо маржа > 150 грн)
- ✅ Запис результатів в Google Таблицю з детальними даними
- ✅ Підсумки по кожному менеджеру
- ✅ Автоматичне форматування таблиці

## Інструкція з встановлення

### 1. Створіть Google Таблицю

1. Відкрийте [Google Таблиці](https://docs.google.com/spreadsheets/)
2. Створіть нову таблицю
3. Назвіть її, наприклад, "Калькулятор допродажів"

### 2. Додайте скрипт

1. У Google Таблиці перейдіть до **Розширення** → **Apps Script**
2. Відкриється редактор скриптів
3. Видаліть весь код за замовчуванням
4. Скопіюйте вміст файлу `upsales_calculator.gs` і вставте в редактор

### 3. Налаштуйте константи

У файлі скрипта знайдіть секцію **КОНФІГУРАЦІЯ** та замініть:

```javascript
const API_KEY = 'ВАШ_API_КЛЮЧ'; // API ключ з KEYCRM
const DATE_FILTER = 'last_month'; // Період для фільтрації замовлень
```

**Як отримати API ключ:**
1. Увійдіть у ваш обліковий запис KEYCRM
2. Перейдіть до **Налаштування** → **Інтеграції** → **API**
3. Створіть новий API ключ або скопіюйте існуючий

**Налаштування періоду:**
- `'last_month'` - минулий місяць (за замовчуванням)
- `'this_month'` - поточний місяць
- `'last_30_days'` - останні 30 днів
- `'custom'` - кастомний період (вкажіть `CUSTOM_START_DATE` та `CUSTOM_END_DATE`)
- `'all'` - всі замовлення без фільтрації

**Примітка:** Скрипт використовує офіційний OpenAPI KEYCRM (`https://openapi.keycrm.app/v1`), тому домен не потрібен.

### 4. Збережіть проект

1. Натисніть **Ctrl+S** (або **Cmd+S** на Mac)
2. Назвіть проект, наприклад, "Калькулятор допродажів"

### 5. Налаштуйте права доступу

1. Натисніть кнопку **Запустити** ▶️ (виберіть функцію `main`)
2. Google запросить дозвіл на доступ до таблиці
3. Натисніть **Дозволити** та підтвердіть права

### 6. Запустіть скрипт

1. У редакторі скриптів виберіть функцію `main` зі списку
2. Натисніть **Запустити** ▶️
3. Перевірте результат у Google Таблиці

**Доступні функції для різних періодів:**
- `main()` або `mainLastMonth()` - за минулий місяць
- `mainThisMonth()` - за поточний місяць
- `mainLast30Days()` - за останні 30 днів
- `mainAll()` - всі замовлення

## Налаштування автоматичного запуску

### Створення тригера

1. У редакторі Apps Script натисніть на іконку **Тригери** (⏰)
2. Натисніть **+ Додати тригер** внизу сторінки
3. Налаштуйте:
   - **Функція для запуску:** `main`
   - **Джерело події:** За часом
   - **Тип тригера:** Таймер
   - **Часовий інтервал:** Виберіть потрібний (наприклад, щодня о 9:00)
4. Натисніть **Зберегти**

## Структура таблиці

Після запуску скрипта створюється лист з наступними стовпцями:

| Стовпець | Опис |
|----------|------|
| Дата | Дата допродажі |
| Менеджер | Ім'я менеджера |
| ID Менеджера | Унікальний ID менеджера |
| Назва допродажі | Назва товару/послуги |
| Ціна продажу (грн) | Ціна, за якою продано |
| Собівартість (грн) | Собівартість товару/послуги |
| Маржа (грн) | Різниця між ціною продажу та собівартістю |
| Бонус менеджера (грн) | 50% від маржі (якщо маржа > 150 грн) |
| ID Замовлення | ID замовлення в KEYCRM |
| ID Допродажі | ID допродажі в KEYCRM |

## Логіка розрахунку

1. **Маржа** = Ціна продажу - Собівартість
2. **Бонус менеджера**:
   - Якщо маржа ≤ 150 грн → бонус = 0 грн
   - Якщо маржа > 150 грн → бонус = маржа × 50%

## Додаткові функції

### Тестування підключення

Для перевірки підключення до KEYCRM API:

1. Виберіть функцію `testConnection` у редакторі
2. Натисніть **Запустити** ▶️
3. Перевірте логи (Вид → Логи)

## Налаштування параметрів

У секції **КОНФІГУРАЦІЯ** можна змінити:

```javascript
const MARGIN_THRESHOLD = 150; // Поріг маржі для нарахування бонусу (грн)
const BONUS_PERCENTAGE = 0.5; // Відсоток бонусу (0.5 = 50%)
const SHEET_NAME = 'Допродажі'; // Назва листа в таблиці
const CONVERT_DATES_TO_UTC_FOR_API = true; // Конвертація дат в UTC для API (змініть на false при проблемах з часом)
```

## Усунення проблем

### Помилка "Помилка API: 401"
- Перевірте правильність API ключа
- Переконайтеся, що API ключ активний

### Помилка "Помилка API: 404"
- Перевірте правильність домену KEYCRM
- Переконайтеся, що API доступний для вашого облікового запису

### Допродажі не знайдено або проблеми з часом
- Перевірте, чи є допродажі в KEYCRM за вказаний період
- **Проблеми з часом:** Якщо в CRM видно замовлення о певному часі, але скрипт їх не знаходить:
  - Змініть `CONVERT_DATES_TO_UTC_FOR_API` з `true` на `false` в коді
  - Це може допомогти, якщо KEYCRM працює з місцевим часом, а не UTC
- Перевірте структуру даних API (може відрізнятися)
- Перегляньте логи для деталей про діапазон дат, який передається в API

### Помилка доступу до таблиці
- Переконайтеся, що надали всі необхідні дозволи
- Перевірте, що таблиця відкрита

## API KEYCRM

Скрипт використовує офіційний OpenAPI KEYCRM:
- **Базовий URL:** `https://openapi.keycrm.app/v1`
- **Ендпоінт:** `/order` (GET)
- **Авторизація:** Bearer token (API ключ)
- **Обмеження:** 60 запитів на хвилину з однієї IP-адреси

Скрипт автоматично:
- Використовує пагінацію для отримання всіх замовлень
- Додає затримку між запитами для дотримання лімітів
- Отримує продукти та інформацію про менеджера через параметр `include`

## Документація

- [KEYCRM OpenAPI Документація](https://keycrm.s3.eu-central-1.amazonaws.com/static/open-api.yml)
- [KEYCRM API Документація](https://docs.keycrm.app/)
- [Google Apps Script Документація](https://developers.google.com/apps-script)

## Підтримка

Якщо виникли проблеми:
1. Перевірте логи в редакторі Apps Script (Вид → Логи)
2. Переконайтеся, що всі налаштування правильні
3. Перевірте документацію KEYCRM API для актуальної структури даних

